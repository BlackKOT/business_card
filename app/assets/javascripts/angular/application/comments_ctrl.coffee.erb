appModule.controller('commentsCtrl', ['$scope', '$http', ($scope, $http) ->
  getResultsPage = (pageNumber) ->
    $http.get('/comments.json?page=' + pageNumber).then (result) ->
      $scope.comments = result.data.Items
      $scope.totalComments = result.data.Count
      return
    return

  $scope.comments = []
  $scope.totaComments = 0
  $scope.commentsPerPage = 5
  getResultsPage 1
  $scope.pagination = current: 1

  $scope.pageChanged = (newPage) ->
    getResultsPage newPage
    return
  return

])

appModule.directive 'commentsList', ->
  {
    restrict: 'A'
#    replace: true
    controller: 'commentsCtrl'
    templateUrl: "<%= asset_path("angular/application/templates/comment.html.slim") %>"
    compile: (tElement, tAttrs, transclude) ->
        rpt = document.createAttribute('ng-repeat')
        rpt.nodeValue = tAttrs.repeatStatement
        tElement[0].children[0].attributes.setNamedItem(rpt)
  }

appModule.directive 'commentForm', ['$FormService', ($FormService) ->
  {
  restrict: 'A'
  scope: true
  controller: ($scope, $attrs) ->
    if $attrs.commentForm == '0'
      console.log 'new post'
    else
      console.log 'old post'

  link: (scope, element, attrs) ->
    scope.submit = ($event) ->
      $event.preventDefault()
      $FormService.clearErrors(element)
      result = $FormService.submit(element)
      result.success =>
        $('#commentModal').modal('hide')
        scope.comments.push(scope.comment);
      result.error (data) =>
        $FormService.displayErrors(element, data)
  }
]

